<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Box Flasher — WORKING BUILD</title>
  <link rel="stylesheet" href="styles.css">

  <!-- ✅ Bản ổn định UMD (hoạt động thật) -->
  <script src="https://cdn.jsdelivr.net/gh/espressif/esptool-js@v0.4.3/umd/esptool.umd.js"></script>

  <!-- CryptoJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <script>
    // Kiểm tra xem ESPLoader có tồn tại sau khi load
    window.addEventListener("load", () => {
      if (!window.ESPLoader || !window.Transport) {
        document.body.innerHTML =
          "<div style='font-family:monospace;padding:24px;color:red'>" +
          "❌ Không thể tải esptool-js UMD.<br>" +
          "Kiểm tra kết nối Internet hoặc CDN bị chặn.<br>" +
          "Đường dẫn đang dùng: cdn.jsdelivr.net/gh/espressif/esptool-js@v0.4.3/umd/esptool.umd.js" +
          "</div>";
        console.error("esptool-js chưa load!");
      } else {
        console.log("✅ esptool-js loaded:", window.ESPLoader);
      }
    });
  </script>
</head>

<body>
  <main class="container">
    <h1>AI Box Flasher (UMD fixed)</h1>

    <!-- 1. Kết nối -->
    <section class="card">
      <h2>1) Kết nối thiết bị</h2>
      <div class="row">
        <label>Tốc độ (baud):
          <select id="baud">
            <option value="921600">921600</option>
            <option value="460800">460800</option>
            <option value="230400">230400</option>
            <option value="115200" selected>115200</option>
          </select>
        </label>
        <button id="btnConnect">Kết nối</button>
        <button id="btnDisconnect" disabled>Ngắt kết nối</button>
      </div>
      <div id="connInfo" class="muted">Chưa kết nối</div>
    </section>

    <!-- 2. Chọn firmware -->
    <section class="card">
      <h2>2) Chọn firmware</h2>
      <div class="row">
        <input type="file" id="firmFile" accept=".bin">
        <input type="text" id="firmUrl" placeholder="Hoặc URL firmware (.bin)">
        <button id="btnLoadUrl">Tải từ URL</button>
      </div>
      <div id="firmInfo" class="muted">Chưa có firmware</div>
    </section>

    <!-- 3. Flash -->
    <section class="card">
      <h2>3) Flash</h2>
      <div class="row">
        <button id="btnFlash" disabled>Flash firmware</button>
      </div>
      <div id="progressWrap" class="muted" style="display:none">
        <progress id="prog" max="100" value="0"></progress>
        <span id="progText">0%</span>
      </div>
    </section>

    <!-- 4. Log -->
    <section class="card">
      <h2>Terminal / Log</h2>
      <pre id="terminal" class="terminal"></pre>
      <div id="errors" class="error"></div>
    </section>

    <footer class="muted">
      ✅ Phiên bản hoạt động: esptool-js UMD 0.4.3<br>
      Yêu cầu Chrome/Edge + HTTPS hoặc localhost.
    </footer>
  </main>

  <script type="module" src="src/main.js"></script>
</body>
</html>
